language: node_js
dist: trusty
sudo: required
node_js:
- 7.3.0
cache:
  directories:
  - node_modules
addons:
  apt:
    packages:
    - mesa-utils
    - xvfb
    - libgl1-mesa-dri
    - libglapi-mesa
    - libosmesa6
before_install:
- openssl aes-256-cbc -K $encrypted_5d2bae8122b8_key -iv $encrypted_5d2bae8122b8_iv
  -in credentials.tar.gz.enc -out credentials.tar.gz -d
- tar -xzf credentials.tar.gz
- sudo mv secrets /secrets && sudo chown $USER /secrets
- export CHROME_BIN=/usr/bin/google-chrome
- export DISPLAY=:99.0
- sudo apt-get install libhdf5-dev
- pip install -r python/requirements.txt
- py.test python/test
script:
- npm install
- npm install --only=dev
before_deploy:
- npm run build-min
- cp -r ./dist/min appengine/static/
- export DEPLOY="false"
- "$(python version.py)"
- if [ "$APPVERSION" == "master" ]; then export DEPLOY="true"; fi
- virtualenv env
- source env/bin/activate
- pip install -t ./appengine/lib -r ./appengine/requirements.txt
deploy:
  provider: gae
  skip_cleanup: true
  keyfile: "/secrets/google-secret.json"
  project: neuromancer-seung-import
  version: "$APPVERSION"
  on:
    all_branches: true
  no_promote: true
  default: "$DEPLOY"
  verbosity: error
  config: "./appengine/app.yaml"
